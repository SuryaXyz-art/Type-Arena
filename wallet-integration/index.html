<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linera Wallet Integration</title>
  </head>
  <body>
    <h1>Linera Wallet Integration Example</h1>
    <p>
      This page demonstrates how to connect to a Linera application using MetaMask.
    </p>

    <button id="connect-wallet-btn">Connect Wallet</button>

    <div id="app" style="display: none;">
      <h2>Connected to Linera</h2>
      <p>Owner: <code id="owner"></code></p>
      <p>Chain ID: <code id="chain-id"></code></p>

      <h2>Application Interaction</h2>
      <p>
        This is where you would interact with your Linera application.
        The example below is for the "counter" application.
      </p>
      <p>Counter value: <span id="count"></span></p>
      <button id="increment-btn">Increment Counter</button>
    </div>

    <script type="importmap">
      {
          "imports": {
              "@linera/client": "./@linera/client/dist/index.js",
              "@linera/metamask": "./@linera/metamask/dist/index.js"
          }
      }
    </script>

    <script type="module">
      import * as linera from '@linera/client';
      import * as linera_metamask from '@linera/metamask';

      const connectWalletBtn = document.getElementById('connect-wallet-btn');
      const appDiv = document.getElementById('app');

      connectWalletBtn.addEventListener('click', async () => {
        try {
          // Hide the connect button and show the app div
          connectWalletBtn.style.display = 'none';
          appDiv.style.display = 'block';

          // Initialize the Linera client
          await linera.initialize();

          // IMPORTANT: Replace with your faucet URL and application ID
          const faucetUrl = 'http://localhost:8080'; // Or your testnet faucet
          const applicationId = 'REPLACE_WITH_YOUR_APPLICATION_ID';

          // Create a signer from MetaMask
          const signer = await new linera_metamask.Signer();

          // Create a faucet client
          const faucet = await new linera.Faucet(faucetUrl);

          // Create a wallet. In a real application, you might want to
          // store and retrieve the wallet from local storage.
          const wallet = await faucet.createWallet();

          // Get the owner's address from the signer
          const owner = await signer.address();
          document.getElementById('owner').innerText = owner;

          // Claim a chain from the faucet
          const chainId = await faucet.claimChain(wallet, owner);
          document.getElementById('chain-id').innerText = chainId;

          // Create a client
          const client = await new linera.Client(wallet, signer);

          // Get a reference to the application
          const counter = await client.application(applicationId);

          // Function to update the counter value
          async function updateCount() {
            const response = await counter.query('{ "query": "query { value }" }');
            document.getElementById('count').innerText = JSON.parse(response).data.value;
          }

          // Initial update
          updateCount();

          // Listen for notifications and update the count
          client.onNotification(notification => {
            updateCount();
          });

          // Handle the increment button click
          const incrementButton = document.getElementById('increment-btn');
          incrementButton.addEventListener('click', () => {
            counter.query('{ "query": "mutation { increment(value: 1) }" }');
          });

        } catch (error) {
          console.error('Failed to connect to Linera:', error);
          alert('Failed to connect to Linera. See the console for more details.');
          // Show the connect button again on failure
          connectWalletBtn.style.display = 'block';
          appDiv.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
